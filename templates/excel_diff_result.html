<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Excel Diff Tool - Results</title>
<style>
    :root {
        --excel-green: #217346;
        --border-color: #d1d4d8;
        --header-bg: #f3f3f3;
        --row-index-bg: #e6e6e6;
        --diff-red: #ffe7e7;
        --diff-red-text: #a94442;
    }
    * { box-sizing: border-box; }

    body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f0f2f5; margin: 20px; color: #333; }

    /* Dashboard Styling */
    .summary-container { display: flex; gap: 20px; margin-bottom: 25px; max-width: 1200px; }
    .stat-card {
        background: white; padding: 20px; border-radius: 8px; border: 1px solid var(--border-color);
        flex: 1; text-align: center; border-top: 5px solid var(--excel-green);
    }
    .stat-card.clickable { cursor: pointer; border-top-color: #d9534f; transition: transform 0.2s; }
    .stat-card.clickable:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .stat-number { font-size: 28px; font-weight: bold; display: block; margin-bottom: 5px; }
    .stat-label { font-size: 11px; text-transform: uppercase; color: #666; font-weight: 600; letter-spacing: 1px; }

    /* Sheet Container */
    .sheet { background: #fff; border: 1px solid var(--border-color); margin-bottom: 30px; border-radius: 4px; overflow: hidden; }
    .sheet-header { padding: 12px 18px; background: var(--excel-green); color: white; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
    .sheet.collapsed .sheet-body { display: none; }
    .diff-badge { background: #d9534f; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 10px; }
    
    .compare-wrapper { display: flex; border: 1px solid var(--border-color); background: #fff; position: relative; }

    .row-pane { width: 45px; background: var(--row-index-bg); border-right: 1px solid var(--border-color); flex-shrink: 0; }
    .row-pane table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    
    /* Dynamic Cell Height with Wrap Support */
    .excel-table td, .row-pane td { 
        border: 1px solid var(--border-color); 
        padding: 5px 10px; 
        font-size: 13px; 
        vertical-align: top;
        white-space: normal;       /* Enable Wrapping */
        word-break: break-word;    /* Break long strings */
        height: auto;              /* Grow with content */
        min-height: 28px;
    }

    .row-pane td { 
        text-align: center; 
        font-size: 11px; 
        color: #666; 
        background: var(--row-index-bg);
    }

    /* Data Panes */
    .file-pane { flex: 1; min-width: 0; display: flex; flex-direction: column; }
    .file-title { background: #fafafa; padding: 8px; font-weight: bold; font-size: 13px; text-align: center; border-bottom: 1px solid var(--border-color); height: 31px; }
    
    .file-scroll, .row-scroll { max-height: 500px; overflow: auto; }
    .row-scroll { overflow: hidden; } 
    
    .excel-table { border-collapse: collapse; table-layout: fixed; width: max-content; }
    .excel-table td { width: 200px; min-width: 150px; }

    .col-header td { 
        background: var(--header-bg); 
        text-align: center; 
        color: #666; 
        font-size: 11px; 
        position: sticky; 
        top: 0; 
        z-index: 10; 
        height: 25px !important;
        white-space: nowrap; 
    }

    .bottom-spacer { height: 45px !important; border: none !important; background: transparent !important; }
    .bottom-spacer td { border: none !important; background: transparent !important; height: 45px !important; }

    .master-scroll-container {
        height: 18px; background: #f9f9f9; overflow-x: auto; overflow-y: hidden;
        border-top: 1px solid var(--border-color); margin-left: 45px;
    }
    .master-scroll-content { height: 1px; }

    .modified { background: var(--diff-red) !important; font-weight: bold; color: var(--diff-red-text); }
    .added    { background: #e6ffed !important; color: #22863a; }
    .deleted  { background: #f6f8fa !important; color: #999; text-decoration: line-through; }
    .row-hidden { display: none !important; }

    .file-scroll::-webkit-scrollbar, .master-scroll-container::-webkit-scrollbar { height: 12px; width: 12px; }
    .file-scroll::-webkit-scrollbar-thumb, .master-scroll-container::-webkit-scrollbar-thumb { 
        background: #ccc; border-radius: 10px; border: 3px solid transparent; background-clip: content-box;
    }
</style>

<script>
    function getColLetter(n) {
        let s = "";
        while (n > 0) {
            let m = (n - 1) % 26;
            s = String.fromCharCode(65 + m) + s;
            n = Math.floor((n - 1) / 26);
        }
        return s;
    }

    function syncRowHeights() {
        const sheetBodies = document.querySelectorAll('.sheet-body:not(.collapsed)');
        sheetBodies.forEach(body => {
            const rows = body.querySelectorAll('tr[data-row-idx]:not(.row-hidden)');
            const rowGroups = {};

            rows.forEach(tr => {
                const idx = tr.dataset.rowIdx;
                if (!rowGroups[idx]) rowGroups[idx] = [];
                rowGroups[idx].push(tr);
            });

            Object.values(rowGroups).forEach(group => { group.forEach(tr => { tr.style.height = 'auto'; });
                let maxHeight = 0;
                group.forEach(tr => { if (tr.offsetHeight > maxHeight) maxHeight = tr.offsetHeight; });
                group.forEach(tr => { tr.style.height = maxHeight + 'px'; });
            });
        });
    }

    function syncVerticalOnly(el) {
        const wrapper = el.closest('.sheet-body');
        const panes = wrapper.querySelectorAll('.file-scroll');
        const rowGutter = wrapper.querySelector('.row-scroll');
        panes.forEach(p => { if (p !== el) p.scrollTop = el.scrollTop; });
        if(rowGutter) rowGutter.scrollTop = el.scrollTop;
    }

    function masterSyncHorizontal(masterEl) {
        const body = masterEl.closest('.sheet-body');
        const panes = body.querySelectorAll('.file-scroll');
        panes.forEach(p => { p.scrollLeft = masterEl.scrollLeft; });
    }

    function toggleDiffView(checkbox) {
        const sheetBody = checkbox.closest('.sheet-body');
        const rows = sheetBody.querySelectorAll('tr[data-row-idx]');
        const groups = {};
        rows.forEach(r => { 
            const idx = r.dataset.rowIdx; 
            if(!groups[idx]) groups[idx] = []; 
            groups[idx].push(r); 
        });
        Object.keys(groups).forEach(idx => {
            const group = groups[idx];
            const hasDiff = group.some(r => r.querySelector('.modified, .added, .deleted'));
            group.forEach(r => {
                if (checkbox.checked && !hasDiff) r.classList.add('row-hidden');
                else r.classList.remove('row-hidden');
            });
        });
        syncRowHeights();
        updateMasterScrollWidth(sheetBody);
    }

    function updateMasterScrollWidth(sheetBody) {
        const tables = sheetBody.querySelectorAll('.excel-table');
        const masterContent = sheetBody.querySelector('.master-scroll-content');
        if (tables.length > 0 && masterContent) {
            let maxWidth = 0;
            tables.forEach(t => { if(t.offsetWidth > maxWidth) maxWidth = t.offsetWidth; });
            masterContent.style.width = maxWidth + "px";
        }
    }

    function toggleSheet(el) { 
        const sheet = el.closest('.sheet');
        sheet.classList.toggle("collapsed");
        if (!sheet.classList.contains("collapsed")) {
            setTimeout(() => {
                updateMasterScrollWidth(sheet.querySelector('.sheet-body'));
                syncRowHeights();
            }, 10);
        }
    }

    function scrollToDiffs() {
        const firstDiffSheet = document.querySelector('.sheet[data-has-diff="true"]');
        if (firstDiffSheet) {
            document.querySelectorAll('.sheet[data-has-diff="true"]').forEach(s => s.classList.remove('collapsed'));
            firstDiffSheet.scrollIntoView({ behavior: 'smooth' });
            setTimeout(syncRowHeights, 100);
        }
    }

    window.onload = () => {
        document.querySelectorAll('.sheet-body:not(.collapsed)').forEach(body => {
            updateMasterScrollWidth(body);
        });
        syncRowHeights();
    };
</script>
</head>
<body>

<h1>Excel Comparison Result</h1>

<div class="summary-container">
    <div class="stat-card">
        <span class="stat-number">{{ diff.keys()|length }}</span>
        <span class="stat-label">Total Sheets</span>
    </div>
    
    <div class="stat-card">
        <span class="stat-number">
            {% set total_rows_ns = namespace(count=0) %}
            {% for sname, sdata in diff.items() %}
                {% set total_rows_ns.count = total_rows_ns.count + sdata.rows|length %}
            {% endfor %}
            {{ total_rows_ns.count }}
        </span>
        <span class="stat-label">Total Rows Scanned</span>
    </div>

    <div class="stat-card clickable" onclick="scrollToDiffs()">
        <span class="stat-number" style="color: #d9534f;">{{ total_diffs }}</span>
        <span class="stat-label">Differences Found (Click to view)</span>
    </div>
</div>

{% for sheet_name, sheet_data in diff.items() %}
    {% set sheet_diff_ns = namespace(count=0) %}
    {% for row in sheet_data.rows %}
        {% for cell in row.cells %}
            {% if cell.status in ['modified', 'added', 'deleted'] %}
                {% set sheet_diff_ns.count = sheet_diff_ns.count + 1 %}
            {% endif %}
        {% endfor %}
    {% endfor %}

<div class="sheet {{ 'collapsed' if sheet_diff_ns.count == 0 }}" data-has-diff="{{ 'true' if sheet_diff_ns.count > 0 else 'false' }}">
    <div class="sheet-header" onclick="toggleSheet(this)">
        <div>
            <span>üìä {{ sheet_name }}</span>
            {% if sheet_diff_ns.count > 0 %}
            <span class="diff-badge">{{ sheet_diff_ns.count }} changes</span>
            {% endif %}
        </div>
        <span>{{ sheet_data.rows|length }} Rows ‚ñº</span>
    </div>
    
    <div class="sheet-body">
        <div style="display: flex; justify-content: flex-end; margin-bottom: 10px; padding-top: 10px; padding-right: 10px;">
            <label style="background: var(--excel-green); color:white; padding: 5px 12px; border-radius: 20px; font-size: 12px; cursor: pointer;">
                <input type="checkbox" onchange="toggleDiffView(this)"> Show Changes Only
            </label>
        </div>

        <div class="compare-wrapper">
            <div class="row-pane">
                <div style="height: 57px; background: var(--header-bg); border-bottom: 1px solid var(--border-color);"></div>
                <div class="row-scroll">
                    <table>
                        {% for row in sheet_data.rows %}
                        <tr data-row-idx="{{ loop.index }}"><td>{{ loop.index }}</td></tr>
                        {% endfor %}
                        <tr class="bottom-spacer"><td></td></tr>
                    </table>
                </div>
            </div>

            <div class="file-pane">
                <div class="file-title">üìÅ {{ excel_a_name }}</div>
                <div class="file-scroll" onscroll="syncVerticalOnly(this)">
                    <table class="excel-table">
                        <tr class="col-header">
                            {% for i in range(sheet_data.max_cols) %}
                            <td><script>document.write(getColLetter({{ loop.index }}))</script></td>
                            {% endfor %}
                        </tr>
                        {% for row in sheet_data.rows %}
                        <tr data-row-idx="{{ loop.index }}">
                            {% for cell in row.cells %}
                            <td class="{{ cell.status }}">{{ cell.a if cell.a is not none else "" }}</td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </table>
                </div>
            </div>

            <div class="file-pane" style="border-left: 4px solid var(--excel-green);">
                <div class="file-title">üìÅ {{ excel_b_name }}</div>
                <div class="file-scroll" onscroll="syncVerticalOnly(this)">
                    <table class="excel-table">
                        <tr class="col-header">
                            {% for i in range(sheet_data.max_cols) %}
                            <td><script>document.write(getColLetter({{ loop.index }}))</script></td>
                            {% endfor %}
                        </tr>
                        {% for row in sheet_data.rows %}
                        <tr data-row-idx="{{ loop.index }}">
                            {% for cell in row.cells %}
                            <td class="{{ cell.status }}">{{ cell.b if cell.b is not none else "" }}</td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </table>
                </div>
            </div>
        </div>

        <div class="master-scroll-container" onscroll="masterSyncHorizontal(this)">
            <div class="master-scroll-content"></div>
        </div>
    </div>
</div>
{% endfor %}

</body>
</html>