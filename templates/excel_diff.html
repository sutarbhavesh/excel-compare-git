<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Excel Diff Tool - Upload</title>

<style>
:root {
    --excel-green: #217346;
    --excel-green-dark: #1a5c38;
    --bg: #f0f2f5;
    --border: #d1d4d8;
    --panel-bg: #ffffff;
    --text-muted: #5f6368;
    --disabled-grey: #a0a0a0;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 30px;
    background: var(--bg);
    color: #333;
}

h1 { margin: 0; color: var(--excel-green); font-weight: 400; font-size: 28px; }
.subtitle { color: var(--text-muted); margin-bottom: 30px; font-size: 14px; }

.diff-wrapper {
    background: var(--panel-bg);
    padding: 30px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    max-width: 1000px;
    margin: 0 auto;
}

.diff-panels { display: flex; gap: 25px; }

.panel {
    flex: 1;
    border: 1px solid var(--border);
    border-radius: 6px;
    overflow: hidden;
    transition: box-shadow 0.2s;
}

.panel-header {
    background: var(--excel-green);
    color: white;
    padding: 12px 18px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
}

.panel-header h3 { margin: 0; font-size: 16px; display: flex; align-items: center; gap: 10px; }
.chevron { font-size: 12px; transition: transform 0.3s ease; }
.panel.collapsed .chevron { transform: rotate(-90deg); }
.panel-body { padding: 20px; }
.panel.collapsed .panel-body { display: none; }

.toggle-bar {
    display: inline-flex;
    background: #e9ecef;
    border-radius: 20px;
    margin-bottom: 20px;
    padding: 3px;
    border: 1px solid #ddd;
}

.toggle-btn {
    padding: 6px 20px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    border-radius: 18px;
    transition: all 0.2s;
    color: #555;
}

.toggle-btn.active {
    background: var(--excel-green);
    color: #fff;
}

#flash-container {
    width: 100%;
    margin-top: 10px;
}

.alert-popup {
    padding: 15px;
    background-color: #f44336;
    color: white;
    margin-bottom: 15px;
    border-radius: 8px;
    font-family: sans-serif;
    position: relative;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    border-left: 8px solid #b71c1c;
}

.close-btn {
    position: absolute;
    right: 15px;
    top: 10px;
    cursor: pointer;
    font-size: 20px;
    font-weight: bold;
}

.form-group { margin-bottom: 15px; }
label { font-size: 12px; font-weight: 600; margin-bottom: 6px; display: block; color: #444; }

input[type="text"], input[type="file"] {
    width: 100%;
    padding: 10px;
    border-radius: 4px;
    border: 1px solid var(--border);
    box-sizing: border-box;
    font-size: 13px;
}

.source-fields { display: none; }
.source-fields.active { display: block; animation: fadeIn 0.3s; }

@keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

.compare-container { text-align: center; margin-top: 40px; }

.compare-btn {
    padding: 14px 60px;
    font-size: 16px;
    font-weight: 600;
    background: linear-gradient(135deg, var(--excel-green), var(--excel-green-dark));
    color: #fff;
    border: none;
    border-radius: 30px;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(33,115,70,0.3);
    transition: all 0.3s ease;
}

.compare-btn:disabled {
    background: var(--disabled-grey);
    cursor: not-allowed;
    box-shadow: none;
    opacity: 0.6;
}

/* --- SPINNER STYLES --- */
#loading-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(255, 255, 255, 0.9);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    backdrop-filter: blur(3px);
}

.loading-hidden { display: none !important; }

.spinner-container { text-align: center; }

.excel-spinner {
    width: 50px; height: 50px;
    border: 5px solid #e1e1e1;
    border-top: 5px solid var(--excel-green);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
}

.loading-text { font-size: 18px; font-weight: 500; color: #333; margin: 0; }
.loading-subtext { font-size: 13px; color: #666; margin-top: 8px; }

@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

</style>

<script>
function togglePanel(panelId) {
    document.getElementById(panelId).classList.toggle("collapsed");
}

// Reset page when navigating back
window.addEventListener('pageshow', function(event) {
    const form = document.getElementById('uploadForm'); 
    const overlay = document.getElementById('loading-overlay');
    
    if (form) {
        form.reset(); 
        // Hide overlay if it was stuck (e.g. from hitting Back button)
        if (overlay) overlay.classList.add('loading-hidden');
        
        // Ensure UI toggles go back to 'Local File'
        selectSource('a', 'pc');
        selectSource('b', 'pc');
    }
    document.querySelectorAll('.file-custom-label').forEach(label => {
        label.textContent = ''; 
    });
    validateForm();
});

function selectSource(side, type) {
    document.querySelectorAll(`.${side}-source`).forEach(el => el.classList.remove("active"));
    document.getElementById(`${side}-${type}`).classList.add("active");

    document.querySelectorAll(`.${side}-btn`).forEach(btn => btn.classList.remove("active"));
    document.getElementById(`${side}-btn-${type}`).classList.add("active");

    document.getElementById(`source_${side}`).value = type;
    validateForm(); 
}

function validateForm() {
    const btn = document.getElementById('submit-btn');
    const sides = ['a', 'b'];
    let isAllValid = true;

    const excelRegex = /\.(xlsx|xls)$/i;

    sides.forEach(side => {
        const type = document.getElementById(`source_${side}`).value;
        if (type === 'pc') {
            const fileInput = document.querySelector(`input[name="file_${side}"]`);
            if (!fileInput.files.length || !excelRegex.test(fileInput.files[0].name)) {
                isAllValid = false;
            }
        } else {
            const branch = document.querySelector(`input[name="branch_${side}"]`).value.trim();
            const path = document.querySelector(`input[name="path_${side}"]`).value.trim();
            const url = document.querySelector(`input[name="url_${side}"]`).value.trim();
            
            if (!branch || !url || !path || !excelRegex.test(path)) {
                isAllValid = false;
            }
        }
    });

    btn.disabled = !isAllValid;
}

document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('uploadForm');
    const overlay = document.getElementById('loading-overlay');
    const inputs = document.querySelectorAll('input');

    inputs.forEach(input => {
        input.addEventListener('input', validateForm);
        input.addEventListener('change', validateForm);
    });

    // Show loading spinner on submit
    form.addEventListener('submit', () => {
        overlay.classList.remove('loading-hidden');
    });

    validateForm();
});
</script>
</head>

<body>
    <div id="loading-overlay" class="loading-hidden">
        <div class="spinner-container">
            <div class="excel-spinner"></div>
            <p class="loading-text">Performing comparison...</p>
            <p class="loading-subtext">Fetching data and analyzing sheets. Please wait.</p>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div id="flash-container">
        {% for category, message in messages %}
            <div class="alert-popup {{ category }}">
            <strong>Wait!</strong> {{ message }}
            <span class="close-btn" onclick="this.parentElement.style.display='none';">&times;</span>
            </div>
        {% endfor %}
        </div>
    {% endif %}
    {% endwith %}

<div style="max-width: 1000px; margin: 0 auto;">
    <h1>Excel Comparison Tool</h1>
    <div class="subtitle">Analyze differences between two workbooks from Git repositories or local storage.</div>
</div>

<div class="diff-wrapper">
<form method="POST" enctype="multipart/form-data" action="/" id="uploadForm">

    <input type="hidden" name="source_a" id="source_a" value="pc">
    <input type="hidden" name="source_b" id="source_b" value="pc">

    <div class="diff-panels">
        <div class="panel" id="panelA">
            <div class="panel-header" onclick="togglePanel('panelA')">
                <h3>üìÅ Excel A (Source)</h3>
                <span class="chevron">‚ñº</span>
            </div>
            <div class="panel-body">
                <div class="toggle-bar">
                    <div class="toggle-btn a-btn active" id="a-btn-pc" onclick="selectSource('a','pc')">Local File</div>
                    <div class="toggle-btn a-btn" id="a-btn-git" onclick="selectSource('a','git')">Git Repository</div>
                </div>

                <div class="source-fields a-source active" id="a-pc">
                    <div class="form-group">
                        <label>Select Workbook (.xlsx, .xls)</label>
                        <input type="file" name="file_a" accept=".xlsx, .xls">
                    </div>
                </div>

                <div class="source-fields a-source" id="a-git">
                    <div class="form-group">
                        <label>Branch Name *</label>
                        <input type="text" name="branch_a" placeholder="e.g. main">
                    </div>
                    <div class="form-group">
                        <label>File Path in Repo (.xlsx, .xls only) *</label>
                        <input type="text" name="path_a" placeholder="folder/data.xlsx, .xls">
                    </div>
                    <div class="form-group">
                        <label>Git URL *</label>
                        <input type="text" name="url_a" placeholder="https://github.com/user/repo">
                    </div>
                </div>
            </div>
        </div>

        <div class="panel" id="panelB">
            <div class="panel-header" onclick="togglePanel('panelB')">
                <h3>üìÅ Excel B (Target)</h3>
                <span class="chevron">‚ñº</span>
            </div>
            <div class="panel-body">
                <div class="toggle-bar">
                    <div class="toggle-btn b-btn active" id="b-btn-pc" onclick="selectSource('b','pc')">Local File</div>
                    <div class="toggle-btn b-btn" id="b-btn-git" onclick="selectSource('b','git')">Git Repository</div>
                </div>

                <div class="source-fields b-source active" id="b-pc">
                    <div class="form-group">
                        <label>Select Workbook (.xlsx, .xls)</label>
                        <input type="file" name="file_b" accept=".xlsx, .xls">
                    </div>
                </div>

                <div class="source-fields b-source" id="b-git">
                    <div class="form-group">
                        <label>Branch Name *</label>
                        <input type="text" name="branch_b" placeholder="e.g. develop">
                    </div>
                    <div class="form-group">
                        <label>File Path in Repo (.xlsx, .xls only) *</label>
                        <input type="text" name="path_b" placeholder="folder/data_v2.xlsx, .xls">
                    </div>
                    <div class="form-group">
                        <label>Git URL *</label>
                        <input type="text" name="url_b" placeholder="https://github.com/user/repo">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="compare-container">
        <button type="submit" class="compare-btn" id="submit-btn" disabled>Run Comparison</button>
    </div>

</form>
</div>

</body>
</html>